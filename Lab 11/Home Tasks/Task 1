#include <stdio.h>
#include <string.h>
#include <ctype.h>
#include <stdlib.h>

#define MAX_STUDENTS 100
#define NAME_LEN 100

typedef struct {
    char name[NAME_LEN];
    int roll;
    int m1, m2, m3;
    float percentage;
    char grade[3];
} Student;

/* Read full line safely */
void read_line(char *buf, int size) {
    char *p;
    if (fgets(buf, size, stdin)) {
        p = strchr(buf, '\n');
        if (p) *p = '\0';
    }
}

/* case-insensitive compare */
int str_icmp(const char *a, const char *b) {
    while (*a && *b) {
        char ca = tolower((unsigned char)*a);
        char cb = tolower((unsigned char)*b);
        if (ca != cb) return ca - cb;
        a++; b++;
    }
    return tolower((unsigned char)*a) - tolower((unsigned char)*b);
}

/* validated integer input */
int read_int_in_range(const char *msg, int low, int high) {
    char buf[100];
    int val;
    int ok;
    char *end;

    while (1) {
        printf("%s", msg);
        if (!fgets(buf, sizeof(buf), stdin)) continue;

        val = (int)strtol(buf, &end, 10);
        ok = 1;

        if (end == buf) ok = 0;
        while (*end) {
            if (!isspace((unsigned char)*end)) { ok = 0; break; }
            end++;
        }

        if (!ok) {
            printf("Invalid input.\n");
            continue;
        }

        if (val < low || val > high) {
            printf("Value must be between %d and %d.\n", low, high);
            continue;
        }

        return val;
    }
}

/* calculate percentage + grade */
void calc(Student *s) {
    float sum = s->m1 + s->m2 + s->m3;
    s->percentage = (sum / 300.0f) * 100.0f;

    if (s->percentage >= 90) strcpy(s->grade, "A+");
    else if (s->percentage >= 80) strcpy(s->grade, "A");
    else if (s->percentage >= 70) strcpy(s->grade, "B+");
    else if (s->percentage >= 60) strcpy(s->grade, "B");
    else if (s->percentage >= 50) strcpy(s->grade, "C");
    else strcpy(s->grade, "F");
}

/* input student */
void input_student(Student *s) {
    printf("Enter name: ");
    read_line(s->name, NAME_LEN);

    s->roll = read_int_in_range("Roll number: ", 1, 1000000);

    s->m1 = read_int_in_range("Marks 1 (0-100): ", 0, 100);
    s->m2 = read_int_in_range("Marks 2 (0-100): ", 0, 100);
    s->m3 = read_int_in_range("Marks 3 (0-100): ", 0, 100);

    calc(s);
}

void print_student(Student *s) {
    printf("Name: %s\n", s->name);
    printf("Roll: %d\n", s->roll);
    printf("Marks: %d %d %d\n", s->m1, s->m2, s->m3);
    printf("Percentage: %.2f\n", s->percentage);
    printf("Grade: %s\n", s->grade);
}

/* search by roll */
int find_by_roll(Student s[], int n, int roll) {
    int i;
    for (i = 0; i < n; i++) {
        if (s[i].roll == roll) return i;
    }
    return -1;
}

/* search by name */
int find_by_name(Student s[], int n, const char *name) {
    int i;
    for (i = 0; i < n; i++) {
        if (str_icmp(s[i].name, name) == 0) return i;
    }
    return -1;
}

/* list by grade */
void list_by_grade(Student s[], int n, const char *g) {
    int i;
    int found = 0;
    for (i = 0; i < n; i++) {
        if (str_icmp(s[i].grade, g) == 0) {
            print_student(&s[i]);
            printf("\n");
            found = 1;
        }
    }
    if (!found) printf("No students with grade %s\n", g);
}

/* class average */
float class_avg(Student s[], int n) {
    int i;
    float sum = 0;
    if (n == 0) return 0;
    for (i = 0; i < n; i++) sum += s[i].percentage;
    return sum / n;
}

/* ranking */
int* rank_students(Student s[], int n) {
    int i, j, t;
    int *idx = (int*) malloc(sizeof(int) * n);

    for (i = 0; i < n; i++) idx[i] = i;

    /* selection sort by percentage desc */
    for (i = 0; i < n - 1; i++) {
        int best = i;
        for (j = i + 1; j < n; j++) {
            if (s[idx[j]].percentage > s[idx[best]].percentage)
                best = j;
        }
        t = idx[i];
        idx[i] = idx[best];
        idx[best] = t;
    }

    return idx;
}

int main() {
    Student s[MAX_STUDENTS];
    int n, i;
    int ch;

    printf("How many students? ");
    n = read_int_in_range("", 0, MAX_STUDENTS);

    for (i = 0; i < n; i++) {
        printf("\nStudent %d:\n", i+1);
        input_student(&s[i]);
    }

    while (1) {
        printf("\n1. Display all\n2. Search by roll\n3. Search by name\n4. Find by grade\n5. Class average\n6. Above/below avg\n7. Ranking\n8. Add student\n9. Exit\n");
        ch = read_int_in_range("Choice: ", 1, 9);

        if (ch == 1) {
            for (i = 0; i < n; i++) {
                print_student(&s[i]);
                printf("\n");
            }
        }

        else if (ch == 2) {
            int roll;
            roll = read_int_in_range("Enter roll: ", 1, 1000000);
            i = find_by_roll(s, n, roll);
            if (i >= 0) print_student(&s[i]);
            else printf("Not found.\n");
        }

        else if (ch == 3) {
            char name[NAME_LEN];
            printf("Enter name: ");
            read_line(name, NAME_LEN);
            i = find_by_name(s, n, name);
            if (i >= 0) print_student(&s[i]);
            else printf("Not found.\n");
        }

        else if (ch == 4) {
            char g[4];
            printf("Enter grade: ");
            read_line(g, 4);
            list_by_grade(s, n, g);
        }

        else if (ch == 5) {
            printf("Class average = %.2f\n", class_avg(s, n));
        }

        else if (ch == 6) {
            float avg = class_avg(s, n);
            printf("Average = %.2f\n", avg);

            printf("Above avg:\n");
            for (i = 0; i < n; i++)
                if (s[i].percentage > avg)
                    printf("%s %.2f\n", s[i].name, s[i].percentage);

            printf("\nBelow or equal avg:\n");
            for (i = 0; i < n; i++)
                if (s[i].percentage <= avg)
                    printf("%s %.2f\n", s[i].name, s[i].percentage);
        }

        else if (ch == 7) {
            int *idx = rank_students(s, n);
            printf("\nRanking:\n");
            for (i = 0; i < n; i++)
                printf("%d) %s (%.2f)\n", i+1, s[idx[i]].name, s[idx[i]].percentage);
            free(idx);
        }

        else if (ch == 8) {
            if (n >= MAX_STUDENTS) {
                printf("Limit reached.\n");
            } else {
                printf("\nAdd Student:\n");
                input_student(&s[n]);
                n++;
            }
        }

        else if (ch == 9) break;
    }

    return 0;
}

